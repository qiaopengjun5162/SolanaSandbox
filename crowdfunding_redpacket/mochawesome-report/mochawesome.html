<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:6,&quot;tests&quot;:10,&quot;passes&quot;:9,&quot;pending&quot;:1,&quot;failures&quot;:0,&quot;start&quot;:&quot;2025-06-27T08:18:13.385Z&quot;,&quot;end&quot;:&quot;2025-06-27T08:18:32.439Z&quot;,&quot;duration&quot;:19054,&quot;testsRegistered&quot;:10,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:10,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;feb14452-b213-4bf2-99ce-e86a172d0700&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;aaa0dcc0-b16d-4897-8731-e585c89daf9d&quot;,&quot;title&quot;:&quot;crowdfunding_redpacket&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;crowdfunding_redpacket\&quot;&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket \&quot;before all\&quot; hook in \&quot;crowdfunding_redpacket\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2172,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n        // 给所有测试账户空投SOL，用于支付gas费\n        yield provider.connection.requestAirdrop(creator.publicKey, 5 * web3_js_1.LAMPORTS_PER_SOL);\n        yield provider.connection.requestAirdrop(backer1.publicKey, 5 * web3_js_1.LAMPORTS_PER_SOL);\n        yield provider.connection.requestAirdrop(backer2.publicKey, 5 * web3_js_1.LAMPORTS_PER_SOL);\n        yield provider.connection.requestAirdrop(airdropClaimer1.publicKey, 5 * web3_js_1.LAMPORTS_PER_SOL);\n        yield provider.connection.requestAirdrop(admin.publicKey, 5 * web3_js_1.LAMPORTS_PER_SOL);\n        // 等待空投确认\n        yield new Promise((resolve) =&gt; setTimeout(resolve, 2000));\n        console.log(\&quot;Test wallets funded.\&quot;);\n    })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d836a091-293b-41f8-88c5-aef2bb8bd77a&quot;,&quot;parentUUID&quot;:&quot;aaa0dcc0-b16d-4897-8731-e585c89daf9d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;9b3ec006-fb0c-4652-8619-e16e765cbedf&quot;,&quot;title&quot;:&quot;0. Global Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Initializes the global config account&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 0. Global Configuration Initializes the global config account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:509,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            [configPDA] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;config\&quot;)], program.programId);\n            yield program.methods\n                .initializeConfig(developerWallet.publicKey)\n                .accounts({\n                admin: admin.publicKey,\n                config: configPDA,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([admin])\n                .rpc();\n            const configAccount = yield program.account.config.fetch(configPDA);\n            chai_1.assert.equal(configAccount.admin.toBase58(), admin.publicKey.toBase58());\n            chai_1.assert.equal(configAccount.developerWallet.toBase58(), developerWallet.publicKey.toBase58());\n            console.log(\&quot;Global config initialized successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9e5910af-65e9-43f4-9c30-a2c463051962&quot;,&quot;parentUUID&quot;:&quot;9b3ec006-fb0c-4652-8619-e16e765cbedf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9e5910af-65e9-43f4-9c30-a2c463051962&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:509,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000},{&quot;uuid&quot;:&quot;9b940cda-b015-4d8e-9275-58940f32a639&quot;,&quot;title&quot;:&quot;1. Initialization and Creation&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Sets up the test environment (mints tokens)&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 1. Initialization and Creation Sets up the test environment (mints tokens)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3034,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            // 创建一个新的代币\n            mint = yield (0, spl_token_1.createMint)(provider.connection, creator, // payer\n            creator.publicKey, // mint authority\n            null, // freeze authority\n            9 // decimals\n            );\n            // 为各个账户创建关联代币账户 (ATA)\n            creatorTokenAccount = yield (0, spl_token_1.createAssociatedTokenAccount)(provider.connection, creator, mint, creator.publicKey);\n            claimer1TokenAccount = yield (0, spl_token_1.createAssociatedTokenAccount)(provider.connection, creator, // airdrop claimer doesn&#x27;t have SOL yet, so creator pays\n            mint, airdropClaimer1.publicKey);\n            backer1TokenAccount = yield (0, spl_token_1.createAssociatedTokenAccount)(provider.connection, creator, mint, backer1.publicKey);\n            backer2TokenAccount = yield (0, spl_token_1.createAssociatedTokenAccount)(provider.connection, creator, mint, backer2.publicKey);\n            // 给创建者的ATA里铸造代币\n            yield (0, spl_token_1.mintTo)(provider.connection, creator, mint, creatorTokenAccount, creator.publicKey, MINT_TOTAL_SUPPLY.toNumber());\n            const creatorAtaInfo = yield (0, spl_token_1.getAccount)(provider.connection, creatorTokenAccount);\n            chai_1.assert.ok(new anchor_1.BN(creatorAtaInfo.amount.toString()).eq(MINT_TOTAL_SUPPLY), \&quot;Creator should have the total supply\&quot;);\n            console.log(`Mint Address: ${mint.toBase58()}`);\n            console.log(`Creator ATA: ${creatorTokenAccount.toBase58()}`);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a54ee353-40dd-4f73-a7bb-040c16f220da&quot;,&quot;parentUUID&quot;:&quot;9b940cda-b015-4d8e-9275-58940f32a639&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Successfully creates a new red packet with default allocations&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 1. Initialization and Creation Successfully creates a new red packet with default allocations&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:476,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            // 找到 PDA 地址\n            [redPacketPDA] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;red_packet\&quot;), creator.publicKey.toBuffer()], program.programId);\n            [solVaultPDA] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;sol_vault\&quot;), redPacketPDA.toBuffer()], program.programId);\n            [tokenVaultPDA] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;token_vault\&quot;), redPacketPDA.toBuffer()], program.programId);\n            // 定义创建参数 (使用默认分配)\n            const params = {\n                mint: mint,\n                totalAmount: MINT_TOTAL_SUPPLY,\n                tokenName: \&quot;TEST\&quot;,\n                tokenSymbol: \&quot;TST\&quot;,\n                fundingGoal: FUNDING_GOAL,\n                allocations: [], // 空数组以触发默认分配\n                airdropMaxCount: new anchor.BN(100),\n                expiryDuration: new anchor.BN(3), // 3 秒\n            };\n            yield program.methods\n                .createCustomRedpacket(params)\n                .accounts({\n                creator: creator.publicKey,\n                redPacket: redPacketPDA,\n                creatorTokenAccount: creatorTokenAccount,\n                solVault: solVaultPDA,\n                tokenVault: tokenVaultPDA,\n                mint: mint,\n                systemProgram: web3_js_1.SystemProgram.programId,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n            })\n                .signers([creator])\n                .rpc();\n            // 验证状态\n            const redPacketAccount = yield program.account.redPacket.fetch(redPacketPDA);\n            chai_1.assert.equal(redPacketAccount.creator.toBase58(), creator.publicKey.toBase58());\n            chai_1.assert.ok(redPacketAccount.fundingGoal.eq(FUNDING_GOAL));\n            chai_1.assert.equal(redPacketAccount.tokenName, \&quot;TEST\&quot;);\n            // 验证代币是否已转入金库\n            const tokenVaultInfo = yield (0, spl_token_1.getAccount)(provider.connection, tokenVaultPDA);\n            chai_1.assert.ok(new anchor_1.BN(tokenVaultInfo.amount.toString()).eq(MINT_TOTAL_SUPPLY));\n            console.log(\&quot;Red Packet created successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a5789f77-08c2-4b86-b497-eec82c70ca80&quot;,&quot;parentUUID&quot;:&quot;9b940cda-b015-4d8e-9275-58940f32a639&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a54ee353-40dd-4f73-a7bb-040c16f220da&quot;,&quot;a5789f77-08c2-4b86-b497-eec82c70ca80&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3510,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000},{&quot;uuid&quot;:&quot;674dbf12-047b-456d-a30e-6686e0f1ef8a&quot;,&quot;title&quot;:&quot;2. Crowdfunding In Progress&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Allows users to support the crowdfunding&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 2. Crowdfunding In Progress Allows users to support the crowdfunding&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1026,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            // Backer 1 支持\n            const [backer1StatePDA] = web3_js_1.PublicKey.findProgramAddressSync([\n                Buffer.from(\&quot;backer_state\&quot;),\n                redPacketPDA.toBuffer(),\n                backer1.publicKey.toBuffer(),\n            ], program.programId);\n            yield program.methods\n                .supportCrowdfunding(LARGE_SUPPORT_AMOUNT)\n                .accounts({\n                redPacket: redPacketPDA,\n                backer: backer1.publicKey,\n                backerState: backer1StatePDA,\n                solVault: solVaultPDA,\n                creator: creator.publicKey,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([backer1])\n                .rpc();\n            // Backer 2 支持\n            const [backer2StatePDA] = web3_js_1.PublicKey.findProgramAddressSync([\n                Buffer.from(\&quot;backer_state\&quot;),\n                redPacketPDA.toBuffer(),\n                backer2.publicKey.toBuffer(),\n            ], program.programId);\n            yield program.methods\n                .supportCrowdfunding(SMALL_SUPPORT_AMOUNT)\n                .accounts({\n                redPacket: redPacketPDA,\n                backer: backer2.publicKey,\n                backerState: backer2StatePDA,\n                solVault: solVaultPDA,\n                creator: creator.publicKey,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([backer2])\n                .rpc();\n            // 验证状态\n            const redPacketAccount = yield program.account.redPacket.fetch(redPacketPDA);\n            const expectedRaised = LARGE_SUPPORT_AMOUNT.add(SMALL_SUPPORT_AMOUNT);\n            chai_1.assert.ok(redPacketAccount.solRaised.eq(expectedRaised), \&quot;SOL raised should be updated correctly.\&quot;);\n            console.log(`Total SOL raised: ${redPacketAccount.solRaised.toString()}`);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f42ba4e-6c5c-47f7-9b08-ed78b8a75e2b&quot;,&quot;parentUUID&quot;:&quot;674dbf12-047b-456d-a30e-6686e0f1ef8a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Allows users to claim airdrops&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 2. Crowdfunding In Progress Allows users to claim airdrops&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:478,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            const [airdropStatePDA] = web3_js_1.PublicKey.findProgramAddressSync([\n                Buffer.from(\&quot;airdrop\&quot;),\n                redPacketPDA.toBuffer(),\n                airdropClaimer1.publicKey.toBuffer(),\n            ], program.programId);\n            yield program.methods\n                .claimAirdrop()\n                .accounts({\n                redPacket: redPacketPDA,\n                claimer: airdropClaimer1.publicKey,\n                airdropState: airdropStatePDA,\n                tokenVault: tokenVaultPDA,\n                claimerAta: claimer1TokenAccount,\n                mint: mint,\n                creator: creator.publicKey,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([airdropClaimer1])\n                .rpc();\n            // 验证状态\n            const redPacketAccount = yield program.account.redPacket.fetch(redPacketPDA);\n            chai_1.assert.equal(redPacketAccount.airdropClaimed, 1, \&quot;Airdrop claimed count should be 1.\&quot;);\n            const airdropStateAccount = yield program.account.airdropState.fetch(airdropStatePDA);\n            chai_1.assert.isTrue(airdropStateAccount.claimed, \&quot;Airdrop state should be marked as claimed.\&quot;);\n            console.log(\&quot;Airdrop claimed successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;36363429-07e1-4032-9fa8-5759cd33fc1b&quot;,&quot;parentUUID&quot;:&quot;674dbf12-047b-456d-a30e-6686e0f1ef8a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6f42ba4e-6c5c-47f7-9b08-ed78b8a75e2b&quot;,&quot;36363429-07e1-4032-9fa8-5759cd33fc1b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1504,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000},{&quot;uuid&quot;:&quot;400c8f63-e85b-4169-9fb2-00887852b3bb&quot;,&quot;title&quot;:&quot;3. Settlement (Success Path)&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Successfully settles a SUCCESSFUL crowdfund&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 3. Settlement (Success Path) Successfully settles a SUCCESSFUL crowdfund&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4285,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            // 注意：在真实世界中，我们需要等待 expiry_time 到达。\n            // 在测试中，我们假设时间已到，直接调用结算。\n            console.log(\&quot;Waiting for crowdfund to expire...\&quot;);\n            yield sleep(4000); // 等待4秒，确保超过3秒的有效期\n            console.log(\&quot;Simulating time has passed, settling crowdfund...\&quot;);\n            yield program.methods\n                .settleCrowdfunding()\n                .accounts({\n                redPacket: redPacketPDA,\n                creator: creator.publicKey,\n                solVault: solVaultPDA,\n                tokenVault: tokenVaultPDA,\n                systemProgram: web3_js_1.SystemProgram.programId,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n            })\n                .signers([creator])\n                .rpc();\n            // 验证状态\n            const redPacketAccount = yield program.account.redPacket.fetch(redPacketPDA);\n            chai_1.assert.isTrue(redPacketAccount.settled, \&quot;Red packet should be settled.\&quot;);\n            chai_1.assert.isTrue(redPacketAccount.success, \&quot;Crowdfund should be successful.\&quot;);\n            chai_1.assert.ok(redPacketAccount.devFundSolAmount.gtn(0), \&quot;Dev fund SOL should be allocated.\&quot;);\n            chai_1.assert.ok(redPacketAccount.protocolFeeAmount.gtn(0), \&quot;Protocol fee SOL should be allocated.\&quot;);\n            console.log(\&quot;Crowdfund settled successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dd9e650a-c243-44f1-b04b-385aa0ff597f&quot;,&quot;parentUUID&quot;:&quot;400c8f63-e85b-4169-9fb2-00887852b3bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Allows backers to claim their vested TOKENS after success&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 3. Settlement (Success Path) Allows backers to claim their vested TOKENS after success&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:461,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            const [backer1StatePDA] = web3_js_1.PublicKey.findProgramAddressSync([\n                Buffer.from(\&quot;backer_state\&quot;),\n                redPacketPDA.toBuffer(),\n                backer1.publicKey.toBuffer(),\n            ], program.programId);\n            yield program.methods\n                .claimTokens()\n                .accounts({\n                redPacket: redPacketPDA,\n                claimer: backer1.publicKey,\n                backerState: backer1StatePDA,\n                tokenVault: tokenVaultPDA,\n                claimerAta: backer1TokenAccount,\n                mint: mint,\n                creator: creator.publicKey,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n            })\n                .signers([backer1])\n                .rpc();\n            // 验证状态\n            const backer1State = yield program.account.backerState.fetch(backer1StatePDA);\n            chai_1.assert.ok(backer1State.claimedAmount.gtn(0), \&quot;Backer should have claimed some tokens.\&quot;);\n            console.log(`Backer 1 claimed ${backer1State.claimedAmount} tokens.`);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e221048d-fd1c-44b1-8093-26c945581324&quot;,&quot;parentUUID&quot;:&quot;400c8f63-e85b-4169-9fb2-00887852b3bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Allows the creator to claim the dev fund SOL after success&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 3. Settlement (Success Path) Allows the creator to claim the dev fund SOL after success&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0e32f218-ed8c-49bb-b5f6-e44b3b7322a7&quot;,&quot;parentUUID&quot;:&quot;400c8f63-e85b-4169-9fb2-00887852b3bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Allows the creator to distribute fees after success&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 3. Settlement (Success Path) Allows the creator to distribute fees after success&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:454,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            const devWalletBalanceBefore = yield provider.connection.getBalance(developerWallet.publicKey);\n            yield program.methods\n                .distributeFees()\n                .accounts({\n                redPacket: redPacketPDA,\n                creator: creator.publicKey,\n                developerWallet: developerWallet.publicKey,\n                solVault: solVaultPDA,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([creator])\n                .rpc();\n            const devWalletBalanceAfter = yield provider.connection.getBalance(developerWallet.publicKey);\n            chai_1.assert.ok(devWalletBalanceAfter &gt; devWalletBalanceBefore, \&quot;Developer wallet should receive fees.\&quot;);\n            const redPacketAccount = yield program.account.redPacket.fetch(redPacketPDA);\n            chai_1.assert.isTrue(redPacketAccount.feesDistributed, \&quot;fees_distributed flag should be true.\&quot;);\n            console.log(\&quot;Fees distributed successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;27ec5641-a9c9-4da0-a10f-24711c0e390a&quot;,&quot;parentUUID&quot;:&quot;400c8f63-e85b-4169-9fb2-00887852b3bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;dd9e650a-c243-44f1-b04b-385aa0ff597f&quot;,&quot;e221048d-fd1c-44b1-8093-26c945581324&quot;,&quot;27ec5641-a9c9-4da0-a10f-24711c0e390a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;0e32f218-ed8c-49bb-b5f6-e44b3b7322a7&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:5200,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000},{&quot;uuid&quot;:&quot;305b96d1-8ca8-4aa0-9c66-c41449c8b48e&quot;,&quot;title&quot;:&quot;4. Settlement (Failure Path)&quot;,&quot;fullFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/tests/crowdfunding_redpacket.ts&quot;,&quot;file&quot;:&quot;/tests/crowdfunding_redpacket.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;4. Settlement (Failure Path)\&quot;&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 4. Settlement (Failure Path) \&quot;before all\&quot; hook in \&quot;4. Settlement (Failure Path)\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2348,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            yield provider.connection.requestAirdrop(creatorFail.publicKey, 2 * web3_js_1.LAMPORTS_PER_SOL);\n            yield provider.connection.requestAirdrop(backerFail.publicKey, 2 * web3_js_1.LAMPORTS_PER_SOL);\n            yield new Promise((resolve) =&gt; setTimeout(resolve, 1000));\n            mintFail = yield (0, spl_token_1.createMint)(provider.connection, creatorFail, creatorFail.publicKey, null, 9);\n            creatorTokenAccountFail = yield (0, spl_token_1.createAssociatedTokenAccount)(provider.connection, creatorFail, mintFail, creatorFail.publicKey);\n            yield (0, spl_token_1.mintTo)(provider.connection, creatorFail, mintFail, creatorTokenAccountFail, creatorFail.publicKey, MINT_TOTAL_SUPPLY.toNumber());\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f79dced9-78a9-4330-9592-4f60dcc04cae&quot;,&quot;parentUUID&quot;:&quot;305b96d1-8ca8-4aa0-9c66-c41449c8b48e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Correctly handles a FAILED crowdfund and allows refunds&quot;,&quot;fullTitle&quot;:&quot;crowdfunding_redpacket 4. Settlement (Failure Path) Correctly handles a FAILED crowdfund and allows refunds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3788,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;__awaiter(void 0, void 0, void 0, function* () {\n            // 找到 PDAs\n            [redPacketPDAFail] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;red_packet\&quot;), creatorFail.publicKey.toBuffer()], program.programId);\n            [solVaultPDAFail] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;sol_vault\&quot;), redPacketPDAFail.toBuffer()], program.programId);\n            [tokenVaultPDAFail] = web3_js_1.PublicKey.findProgramAddressSync([Buffer.from(\&quot;token_vault\&quot;), redPacketPDAFail.toBuffer()], program.programId);\n            // 创建一个注定会失败的项目 (高目标，低支持)\n            const params = {\n                mint: mintFail,\n                totalAmount: MINT_TOTAL_SUPPLY,\n                tokenName: \&quot;FAIL\&quot;,\n                tokenSymbol: \&quot;FAL\&quot;,\n                fundingGoal: new anchor_1.BN(10 * web3_js_1.LAMPORTS_PER_SOL), // 目标很高\n                allocations: [],\n                airdropMaxCount: new anchor.BN(100),\n                expiryDuration: new anchor.BN(1), // 立即过期\n            };\n            yield program.methods\n                .createCustomRedpacket(params)\n                .accounts({\n                creator: creatorFail.publicKey,\n                redPacket: redPacketPDAFail,\n                creatorTokenAccount: creatorTokenAccountFail,\n                solVault: solVaultPDAFail,\n                tokenVault: tokenVaultPDAFail,\n                mint: mintFail,\n                systemProgram: web3_js_1.SystemProgram.programId,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n            })\n                .signers([creatorFail])\n                .rpc();\n            // 用户支持一点点\n            const [backerFailStatePDA] = web3_js_1.PublicKey.findProgramAddressSync([\n                Buffer.from(\&quot;backer_state\&quot;),\n                redPacketPDAFail.toBuffer(),\n                backerFail.publicKey.toBuffer(),\n            ], program.programId);\n            yield program.methods\n                .supportCrowdfunding(SMALL_SUPPORT_AMOUNT)\n                .accounts({\n                redPacket: redPacketPDAFail,\n                backer: backerFail.publicKey,\n                backerState: backerFailStatePDA,\n                solVault: solVaultPDAFail,\n                creator: creatorFail.publicKey,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([backerFail])\n                .rpc();\n            // 模拟等待\n            yield new Promise((resolve) =&gt; setTimeout(resolve, 2000));\n            // 结算失败的项目\n            yield program.methods\n                .settleCrowdfunding()\n                .accounts({\n                redPacket: redPacketPDAFail,\n                creator: creatorFail.publicKey,\n                solVault: solVaultPDAFail,\n                tokenVault: tokenVaultPDAFail,\n                systemProgram: web3_js_1.SystemProgram.programId,\n                tokenProgram: spl_token_1.TOKEN_PROGRAM_ID,\n            })\n                .signers([creatorFail])\n                .rpc();\n            let redPacketAccount = yield program.account.redPacket.fetch(redPacketPDAFail);\n            chai_1.assert.isTrue(redPacketAccount.settled, \&quot;Should be settled.\&quot;);\n            chai_1.assert.isFalse(redPacketAccount.success, \&quot;Should be marked as failed.\&quot;);\n            console.log(\&quot;Failed crowdfund settled correctly.\&quot;);\n            // Backer 进行退款\n            const backerBalanceBefore = yield provider.connection.getBalance(backerFail.publicKey);\n            yield program.methods\n                .refund()\n                .accounts({\n                redPacket: redPacketPDAFail,\n                backer: backerFail.publicKey,\n                backerState: backerFailStatePDA,\n                solVault: solVaultPDAFail,\n                creator: creatorFail.publicKey,\n                systemProgram: web3_js_1.SystemProgram.programId,\n            })\n                .signers([backerFail])\n                .rpc();\n            const backerBalanceAfter = yield provider.connection.getBalance(backerFail.publicKey);\n            chai_1.assert.ok(backerBalanceAfter &gt; backerBalanceBefore, \&quot;Backer&#x27;s balance should increase after refund.\&quot;);\n            console.log(\&quot;Backer refunded successfully.\&quot;);\n        })&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1fff8286-b324-4087-9679-5557643261e7&quot;,&quot;parentUUID&quot;:&quot;305b96d1-8ca8-4aa0-9c66-c41449c8b48e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1fff8286-b324-4087-9679-5557643261e7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3788,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:1000000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:1000000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;9.2.2&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;crowdfunding_redpacket&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/qiaopengjun/Code/Solana/solana/aidr-protocal/crowdfunding_redpacket/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>